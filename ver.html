<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa con LeafletJS y Cálculo de Costo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        .container {
            margin: 20px;
        }
        .leaflet-routing-container {
            display: none !important;
        }
        .leaflet-bar,
        .leaflet-routing-controls {
            display: none !important;
        }
        .leaflet-control-zoom {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mapa con LeafletJS y Cálculo de Distancia</h1>
        
        <label for="date">Selecciona la fecha:</label>
        <input type="date" id="date">
        <br><br>

        <label for="destination-name">Introduce un destino (opcional):</label>
        <input type="text" id="destination-name" placeholder="Ej: Trabajo, Casa de Juan">
        <br><br>

        <button id="calculate">Buscar y Calcular</button>
        <br><br>
        
        <div id="details">
            <p id="result"></p>
            <button id="whatsapp" style="display:none;">Enviar a WhatsApp</button>
        </div>
        
        <div id="map"></div>
    </div>

    <script>
    const initialPoint = [-34.452115, -58.826254];
    const map = L.map('map').setView(initialPoint, 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let routeControl;
    let destinationMarker;
    let selectedDestination = null;
    let destinationName = "";

    const locationIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    // Evento al seleccionar un punto en el mapa
    map.on('click', (e) => {
        selectedDestination = [e.latlng.lat, e.latlng.lng];
        destinationName = "Ubicación seleccionada en el mapa";
        setDestinationMarker(selectedDestination, destinationName);
    });

    document.getElementById('calculate').addEventListener('click', () => {
        const date = document.getElementById('date').value;
        const inputDestinationName = document.getElementById('destination-name').value;

        // Usar el nombre del destino ingresado si existe, de lo contrario mantener el seleccionado en el mapa
        if (inputDestinationName) {
            destinationName = inputDestinationName;
        }

        if (!selectedDestination && !inputDestinationName) {
            alert("Por favor, selecciona un punto en el mapa o escribe un destino.");
            return;
        }

        if (!date) {
            alert("Por favor, selecciona una fecha.");
            return;
        }

        if (inputDestinationName && !selectedDestination) {
            // Si se ingresó un destino, buscarlo en el mapa
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(inputDestinationName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        alert("No se encontró la ubicación escrita. Intenta con otra.");
                        return;
                    }

                    const { lat, lon } = data[0];
                    selectedDestination = [parseFloat(lat), parseFloat(lon)];
                    setDestinationMarker(selectedDestination, inputDestinationName);
                    const month = new Date(date).getMonth();
                    calculateRoute(initialPoint, selectedDestination, month, date, destinationName);
                })
                .catch(error => {
                    console.error("Error al buscar la ubicación:", error);
                    alert("Hubo un problema al buscar la ubicación.");
                });
        } else {
            // Si ya hay una ubicación seleccionada en el mapa
            const month = new Date(date).getMonth();
            calculateRoute(initialPoint, selectedDestination, month, date, destinationName);
        }
    });

    function setDestinationMarker(destination, popupText) {
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }

        destinationMarker = L.marker(destination, { icon: locationIcon })
            .addTo(map)
            .bindPopup(popupText)
            .openPopup();

        map.setView(destination, 13);
    }

    function calculateRoute(origin, destination, month, date, destinationName) {
        if (routeControl) {
            map.removeControl(routeControl);
        }

        routeControl = L.Routing.control({
            waypoints: [
                L.latLng(origin[0], origin[1]),
                L.latLng(destination[0], destination[1])
            ],
            routeWhileDragging: true,
            lineOptions: {
                styles: [{ color: '#00000000', weight: 4, opacity: 0.2 }]
            },
            createMarker: () => null,
            showAlternatives: false,
            instructions: false
        }).addTo(map);

        routeControl.on('routesfound', (e) => {
            const routes = e.routes;
            const distance = routes[0].summary.totalDistance / 1000;

            let basePrice = 100000 + (month * 3000);
            let totalPrice = basePrice;

            let extraKm = distance - 3;
            if (extraKm > 0) {
                totalPrice += extraKm * 2000;
            }

            totalPrice = totalPrice.toFixed(0);
            const formattedDate = new Date(date).toLocaleDateString('es-ES');

            const resultText =
                `Destino: ${destinationName}<br>` +
                `Fecha: ${formattedDate}<br>` +
                `Distancia: ${distance.toFixed(2)} km<br>` +
                `Precio: $${totalPrice.replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

            document.getElementById('result').innerHTML = resultText;

            const googleMapsLink = `https://www.google.com/maps?q=${destination[0]},${destination[1]}`;
            const whatsappMessage = encodeURIComponent(`Destino: ${destinationName}\nFecha: ${formattedDate}\nDistancia: ${distance.toFixed(2)} km\nPrecio: $${totalPrice.replace(/\B(?=(\d{3})+(?!\d))/g, ".")}\nMapa: ${googleMapsLink}`);
            const whatsappLink = `https://wa.me/541144382987?text=${whatsappMessage}`;

            const whatsappButton = document.getElementById('whatsapp');
            whatsappButton.style.display = 'inline-block';
            whatsappButton.onclick = () => {
                window.open(whatsappLink, '_blank');
            };
        });

        routeControl.on('routingerror', () => {
            alert("No se pudo calcular la ruta. Intenta con otra ubicación.");
        });
    }
    </script>
</body>
</html>
